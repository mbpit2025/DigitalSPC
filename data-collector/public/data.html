<!-- data.html -->

<!DOCTYPE html>
<html lang="en">


<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>PLC Latest Data Dashboard</title>

Â  <!-- âœ… Tailwind CDN -->
Â  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-gray-100 font-sans min-h-screen">

  <!-- âœ… NAVBAR (SAMA DENGAN HOME) -->
  <nav class="bg-gray-800 border-b border-gray-700">
    <div class="max-w-screen-xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-6">
        <a href="http://localhost:3001" class="  hover:text-blue-300">Home</a>
        <a href="http://localhost:3001/connection" class="hover:underline text-blue-400 font-semibold">Connection</a>

        <!-- âœ… Dropdown FIXED -->
        <div class="relative group">
          <button class="hover:text-blue-300">API â–¾</button>
          <div
            class="absolute opacity-0 invisible group-hover:opacity-100 group-hover:visible hover:opacity-100 hover:visible
             bg-gray-800 border border-gray-700 rounded-md shadow-lg mt-2 p-2 w-48 z-50 transition-all duration-200">
            <a href="http://localhost:3001/api/latest-data"
            target="_blank" rel="noopener noreferrer"
             class="block px-3 py-2 hover:bg-gray-700 rounded">Latest Data</a>
            <a href="http://localhost:3001/api/update-alias"
            target="_blank" rel="noopener noreferrer"
             class="block px-3 py-2 hover:bg-gray-700 rounded">Alias</a>
            <a href="http://localhost:3001/api/connection-status"
            target="_blank" rel="noopener noreferrer"
             class="block px-3 py-2 hover:bg-gray-700 rounded">Connection Status</a>
          </div>
        </div>
      </div>
    </div>
  </nav>

Â  <div class="max-w-screen-xl mx-auto px-4 ">

Â  <h1 class="text-3xl font-bold text-blue-400">Real-Time Modbus Data Collector</h1>

Â  Â  <!-- âœ… Controls -->
Â  Â  <div id="control-container" class="flex items-center gap-5 text-sm bg-gray-800 p-3 rounded-md border border-gray-700">
Â  Â  Â  <span id="last-updated" class="font-bold">Loading...</span>

Â  Â  Â  <label for="refresh-interval">Refresh Interval:</label>
Â  Â  Â  <select id="refresh-interval"
Â  Â  Â  Â  class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-gray-100">
Â  Â  Â  Â  <option value="1000">1 Detik</option>
Â  Â  Â  Â  <option value="3000">3 Detik</option>
Â  Â  Â  Â  <option value="5000">5 Detik</option>
Â  Â  Â  Â  <option value="10000">10 Detik</option>
Â  Â  Â  Â  <option value="1000" selected>1 Detik</option>
Â  Â  Â  </select>

Â  Â  Â  <div id="countdown-container" class="ml-auto flex gap-1">
Â  Â  Â  Â  <span>| Next Refresh in:</span>
Â  Â  Â  Â  <span id="countdown" class="font-bold text-yellow-300">1</span>s â³
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- âœ… Dashboard -->
Â  Â  <div id="plc-data-dashboard"
Â  Â  Â  class="grid grid-cols-6 gap-5 mt-2 overflow-x-auto"></div>

Â  Â  <div id="plc-skeleton" class="flex flex-wrap gap-5 mt-6">
Â  Â  Â  <div class="skeleton w-full h-[180px] flex items-center justify-center">Loading PLC Data ...</div>
Â  Â  </div>


Â  </div>
Â  <footer class="flex w-full p-6 justify-center items-center bg-black/50 py-8 text-gray-400">
Â  Â  <p>Minz Digitalization System</p>
Â  </footer>

Â  <script>
Â  Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  Â  document.getElementById("plc-skeleton").style.display = "flex";
Â  Â  Â  const API_URL = "/api/latest-data";
Â  Â  Â  const TAG_API_URL = "/api/update-alias";
Â  Â  Â  let tagNames = {};
Â  Â  Â  let REFRESH_INTERVAL_MS = parseInt(document.getElementById("refresh-interval").value);
Â  Â  Â  let pollingIntervalId;
Â  Â  Â  let countdownTimer;

Â  Â  Â  function requiresDecimalFormat(tagName) {
Â  Â  Â  Â  if (!tagName.startsWith('data')) return false;
Â  Â  Â  Â  const index = parseInt(tagName.substring(4));
Â  Â  Â  Â  return index >= 2 && index <= 9;
Â  Â  Â  }

Â  Â  Â  async function saveTagName(plc_name, tag_name, alias) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const res = await fetch(TAG_API_URL, {
Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ plc_name, tag_name, alias }),
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  const result = await res.json();
Â  Â  Â  Â  Â  if (result.status === "success") {
Â  Â  Â  Â  Â  Â  tagNames[`${plc_name}_${tag_name}`] = alias;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  console.error("[ALIAS ERROR] Gagal kirim:", err);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  function startCountdown() {
Â  Â  Â  Â  clearInterval(countdownTimer);
Â  Â  Â  Â  let seconds = REFRESH_INTERVAL_MS / 1000;
Â  Â  Â  Â  const el = document.getElementById("countdown");
Â  Â  Â  Â  el.textContent = seconds;
Â  Â  Â  Â  countdownTimer = setInterval(() => {
Â  Â  Â  Â  Â  seconds--;
Â  Â  Â  Â  Â  el.textContent = seconds > 0 ? seconds : "0";
Â  Â  Â  Â  Â  if (seconds <= 0) clearInterval(countdownTimer);
Â  Â  Â  Â  }, 1000);
Â  Â  Â  }

Â  Â  Â  document.getElementById("refresh-interval").addEventListener("change", (e) => {
Â  Â  Â  Â  REFRESH_INTERVAL_MS = parseInt(e.target.value);
Â  Â  Â  Â  clearInterval(pollingIntervalId);
Â  Â  Â  Â  pollingIntervalId = setInterval(fetchData, REFRESH_INTERVAL_MS);
Â  Â  Â  Â  startCountdown();
Â  Â  Â  });

Â  Â  Â  function groupDataByPlc(data) {
Â  Â  Â  Â  return data.reduce((acc, item) => {
Â  Â  Â  Â  Â  if (!acc[item.plc_name]) acc[item.plc_name] = [];
Â  Â  Â  Â  Â  acc[item.plc_name].push(item);
Â  Â  Â  Â  Â  return acc;
Â  Â  Â  Â  }, {});
Â  Â  Â  }

      function pausePolling() {
        if (pollingIntervalId) {
          clearInterval(pollingIntervalId);
          pollingIntervalId = null;
          clearInterval(countdownTimer);
          document.getElementById("countdown").textContent = "STOP";
          document.getElementById("last-updated").textContent = "Editing Alias...";
          console.log("Polling paused during edit.");
        }
      }

      function resumePolling() {
        // Delay kecil untuk memastikan alias benar-benar tersimpan
        setTimeout(() => {
          if (!pollingIntervalId) {
            pollingIntervalId = setInterval(fetchData, REFRESH_INTERVAL_MS);
            fetchData();       // langsung ambil data baru
            startCountdown();  // mulai ulang countdown
            console.log("Polling resumed after edit.");
          }
        }, 350);
      }


      async function fetchData() {
        try {
          startCountdown();
          const response = await fetch(API_URL);
          const result = await response.json();

          const dashboard = document.getElementById("plc-data-dashboard");
          const skeleton = document.getElementById("plc-skeleton");
          const lastUpdated = document.getElementById("last-updated");

          dashboard.innerHTML = "";

          // â›” Jika belum ada data
          if (!result.data || result.data.length === 0) {
            skeleton.style.display = "flex";
            lastUpdated.textContent = "Menunggu data PLC...";
            return;
          }

          skeleton.style.display = "none";

          if (result.status === "success" && result.data.length > 0) {
            lastUpdated.textContent =
              "Last Data Poll: " +
              new Date(result.timestamp).toLocaleTimeString("id-ID", {
                timeZone: "Asia/Jakarta",
              });

            const grouped = groupDataByPlc(result.data);

            // ğŸ­ Loop tiap PLC
            for (const plcName in grouped) {
              const box = document.createElement("div");
              box.className =
                "bg-gray-800 border border-gray-700 rounded-lg p-4 col-span-3 lg:col-span-2";

              // ğŸ“Œ Title PLC
              const title = document.createElement("h2");
              title.className =
                "text-xl font-semibold text-gray-200 border-b border-gray-700 pb-1 mb-3";
              title.textContent = plcName;
              box.appendChild(title);

              // ğŸ“± Responsive wrapper
              const tableWrapper = document.createElement("div");
              tableWrapper.className = "overflow-x-auto w-full";

              // ğŸ“‹ Table
              const table = document.createElement("table");
              table.className =
                "w-full text-sm border-collapse text-gray-100 ";

              table.innerHTML = `
                <thead>
                  <tr class="bg-blue-600 text-white">
                    <th class="px-4 py-2 text-left font-semibold">Tag Name</th>
                    <th class="px-4 py-2 text-left font-semibold">Raw Value</th>
                    <th class="px-4 py-2 text-left font-semibold">Value</th>
                    <th class="px-4 py-2 text-left font-semibold">Timestamp</th>
                  </tr>
                </thead>
                <tbody></tbody>
              `;

              const tbody = table.querySelector("tbody");

              // ğŸ“Œ Loop tiap tag
              grouped[plcName].forEach((item) => {
                const tr = document.createElement("tr");
                tr.className = "odd:bg-gray-700 hover:bg-gray-600";

                // ğŸŸ¦ Editable Tag Name
                const key = `${item.plc_name}_${item.tag_name}`;
                const tagCell = document.createElement("td");
                tagCell.className = "px-4 py-2 cursor-pointer font-medium";
                tagCell.textContent =
                  item.alias || tagNames[key] || item.tag_name;

                tagCell.ondblclick = () => {
                  pausePolling();
                  const input = document.createElement("input");
                  input.className =
                    "bg-gray-900 border border-gray-600 text-gray-100 w-full text-sm px-2 py-1 rounded";
                  input.value = tagCell.textContent;
                  tagCell.textContent = "";
                  tagCell.appendChild(input);
                  input.focus();

                  const finishEdit = async () => {
                    const newAlias = input.value.trim() || item.tag_name;
                    if (newAlias !== tagCell.textContent) {
                      await saveTagName(item.plc_name, item.tag_name, newAlias);
                    }
                    tagCell.textContent = newAlias;
                    resumePolling();
                  };

                  input.onblur = finishEdit;

                  input.onkeydown = (e) => {
                    if (e.key === "Enter") input.blur();
                    if (e.key === "Escape") {
                      input.value = item.tag_name;
                      input.blur();
                    }
                  };
                };

                // ğŸ”¢ Nilai (kalibrasi decimal jika perlu)
                let calibrated = requiresDecimalFormat(item.tag_name)
                  ? Number(item.value).toFixed(1)
                  : item.value;

                // ğŸŸ© Kolom lain
                const cols = [
                  item.raw_value,
                  calibrated,
                  new Date(item.timestamp).toLocaleTimeString("id-ID", {
                    timeZone: "Asia/Jakarta",
                  }),
                ];

                cols.forEach((val) => {
                  const td = document.createElement("td");
                  td.className = "px-4 py-2";
                  td.textContent = val;
                  tr.appendChild(td);
                });

                tr.prepend(tagCell);
                tbody.appendChild(tr);
              });

              tableWrapper.appendChild(table);
              box.appendChild(tableWrapper);
              dashboard.appendChild(box);
            }
          } else {
            lastUpdated.textContent = "No Data Available";
          }
        } catch (error) {
          console.error(error);
          document.getElementById("last-updated").textContent =
            "Koneksi API Gagal / Server Offline!";
          clearInterval(countdownTimer);
        }
      }

      // ğŸš€ Start Auto Polling
      fetchData();
      pollingIntervalId = setInterval(fetchData, REFRESH_INTERVAL_MS);

    }); 

Â  </script>

</body>
</html>
